# Google Calendar

## 1. Тема и целевая аудитория

**Google Calendar** — сервис для планирования встреч, событий и дел, организации рабочего времени.

### MVP

- Регистрация, авторизация.
- Создание, редактирование календарей.
- Каждый календарь можно сделать общедоступным либо предоставить отдельным пользователям права на просмотр и
  редактирование.
- Уведомления и приглашения в календарь по электронной почте.
- Создание, редактирование напоминаний (событий).

### Целевая аудитория

MAU = 500
млн. [[1]](https://www.patronum.io/key-google-workspace-statistics-for-2023/#:~:text=Google%20Calendar%20has%20over%20500%20million%20active%20users%20per%20month.)

Из-за отсутствия информации о DAU, примем его равным 20 млн. пользователей.

#### Географическое распространение [[2]](https://hypestat.com/info/calendar.google.com#:~:text=Visitors%20by%20country,2.8%25)

| Страна   | Процент пользователей от общего числа, % | Количество, млн |
|----------|:----------------------------------------:|:---------------:|
| США      |                  18.8%                   |       94        |
| Индия    |                  10.7%                   |      53.5       |
| Япония   |                   5.2%                   |       26        |
| Россия   |                   2.9%                   |      14.5       |
| Бразилия |                   2.8%                   |       14        | 

## 2. Расчет нагрузки

### Продуктовые метрики

#### Хранилище пользователя

- Профиль:
    - email - 254
      байт [[3]](https://www.rfc-editor.org/errata_search.php?rfc=3696&eid=1690#:~:text=the%20upper%0A%20%20%20limit%20on%20address%20lengths%20should%20normally%20be%20considered%20to%20be%20254.)
    - Хэшированный пароль - 64
      байт [[4]](https://www.ory.sh/docs/troubleshooting/bcrypt-secret-length#:~:text=BCrypt%20hashed%20passwords%20and%20secrets%20have%20a%2072%20character%20limit.%20This%20is%20a%20limitation%20of%20the%20BCrypt%20algorithm%20and%20the%20Golang%20BCrypt%20library.)
    - first name + last name - 100
      байт [[5]](https://www.geekslop.com/technology-articles/2016/here-are-the-recommended-maximum-data-length-limits-for-common-database-and-programming-fields#:~:text=35%20chars%20(US)%2C-,50%20(other),-Last%20name)
    - Часовой пояс - 4 байт, ссылка на часовой пояс в таблице часовых поясов
    - **Общий размер:** 254 + 64 + 100 + 4 = 422 байт

- Календари:
    - Примем среднее кол-во личных календарей пользователя равным 2.
    - Название - 100 байт.
    - Описание - 500 байт.
    - Часовой пояс - 4 байт, ссылка на часовой пояс.
    - Владелец - 4 байт, ссылка на пользователя.
    - Время создания - 8 байт.
    - Время обновления - 8 байт.
    - Размер одного календаря: 100 + 500 + 4 + 4 + 8 + 8 = 624 байт.
    - **Общий размер:** 2 * 624 байт = 1248 байт = 1.22 Kбайт.

- Подписки на календари:
    - Примем среднее кол-во подписок на чужие календари равным 3.
    - Календарь - 4 байт, ссылка на календарь
    - Подписчик - 4 байт, ссылка на пользователя
    - **Общий размер:** 3 * (4 + 4) = 24 байт

- События:
    - Примем среднее кол-во личных событий пользователя равным 30.
    - Название - 100 байт.
    - Описание - 1000 байт.
    - Владелец - 4 байт, ссылка на пользователя.
    - Календарь - 4 байт, ссылка на календарь.
    - Время начала - 8 байт.
    - Время окончания - 8 байт.
    - Время создания - 8 байт.
    - Время обновления - 8 байт.
    - Размер одного события: 100 + 1000 + 4 + 4 + 8 + 8 + 8 + 8 = 1140 байт.
    - **Общий размер:** 30 * 1140 = 34200 байт = 33.4 Кбайт.

- Подписки на события:
    - Примем среднее кол-во подписок на чужие события равным 20.
    - Событие - 4 байт, ссылка на событие
    - Подписчик - 4 байт, ссылка на пользователя
    - **Общий размер:** 20 * (4 + 4) = 160 байт.

- Уведомления:
    - Примем среднее кол-во уведомлений равным 2 (в момент начала события и одно заранее).
    - Тогда среднее кол-во уведомлений пользователя равно (20 + 30) * 2 = 100.
    - Размер информации уведомления примем ~500 байт.
    - **Общий размер:** 100 * 500 байт = 50000 байт = 48.8 Кбайт.

| **Тип**               | **Хранилище 1-го пользователя** |
|-----------------------|---------------------------------|
| Профиль               | 422 байт                        |
| Календари             | 1.22 Кбайт                      |
| Подписки на календари | 24 байт                         |
| События               | 33.4 Кбайт                      |
| Подписки на события   | 160 байт                        |
| Уведомления           | 48.8 Кбайт                      |

#### Среднее количество действий пользователя по типам в день

| **Тип действия**       | **Частота** |
|------------------------|-------------|
| Просмотр календарей    | 3 / день    |
| Создание события       | 1 / день    |
| Редактирование события | 1 / 2 дня   |
| Получение уведомления  | 2 / день    |

### Технические метрики

#### Размер хранения в разбивке по типам данных

Так как кол-во зарегистрированных аккаунтов в Google Workspace равно 3
млрд [[6]](https://developers.googleblog.com/2022/01/year-in-review-google-workspace.html#:~:text=Google%20Workspace%20grew%20to%20more%20than%203%20billion%20users%20globally)
и MAU Google Calendar равно 500 млн, то возьмем количество зарегистрированных пользователей в нашем календаре равным 1
млрд.

Уведомления и события хранятся только у активных пользователей, а профиль и календари необходимо хранить для всех
зарегистрированных.

- Профиль: 422 байт * 1 млрд = 393 Гбайт.
- Календари: 1.22 Кбайт * 1 млрд = 1.13 Тбайт.
- События: 33.4 Кбайт * 500 млн = 15.55 Тбайт.
- Уведомления: 48.8 Кбайт * 500 млн = 22.74 Тбайт.

#### Сетевой трафик

Средний RPS будем считать по следующей формуле:

*DAU * кол-во действий в день * кол-во запросов для действия / 86400 сек*

Сумарный суточный трафик будем считать по следующей формуле:

*DAU * кол-во действий в день * кол-во байт пересылаемых запросами для совершения действия*

Средний трафик будем считать по следующей формуле:

*Сумарный суточный трафик * 8 / 86400 сек*

1. Просмотр календарей.

   Один просмотр включает запрос на получение двух календарей вместе событиями и запрос на получение данных
   пользователя.

   **Средний RPS:** 20 млн * 3 * (1 + 1) / 86400 сек = 1389 RPS.

   Пусть в календаре каждый день в среднем 1 событие. События прогружаются на месяц.
   Значит, в среднем запрос календаря включает получение 30 событий.

   **Сумарный суточный трафик:** 20 млн * 3 * (2 * (624 + 30 * 1140) + 422) байт = 3.82 Пбайт/сутки.

   **Средний трафик:** 3.82 Пбайт/сутки * 8 / 86400 сек = 389277778 бит/с = 389.28 Мбит/с.

2. Создание события.

   **Средний RPS:** 20 млн * 1 * 1 / 86400 сек = 232 RPS.

   **Сумарный суточный трафик:** 20 млн * 1 * 1140 байт = 21.23 Гбайт/сутки.

   **Средний трафик:** 21.23 Гбайт/сутки * 8 / 86400 сек = 2111111 бит/с = 2.11 Мбит/с.

3. Редактирование события.

   **Средний RPS:** 20 млн * (1 / 2) * 1 / 86400 сек = 116 RPS.

   **Сумарный суточный трафик:** 20 млн * (1 / 2) * 1140 байт = 10.61 Гбайт/сутки.

   **Средний трафик:** 10.61 Гбайт/сутки * 8 / 86400 сек = 1055555 бит/с = 1.05 Мбит/с.

4. Получение уведомлений.

   **Средний RPS:** 20 млн * 2 * 1 / 86400 сек = 463 RPS.

   **Сумарный суточный трафик:** 20 млн * 2 * 500 байт = 18.62 Гбайт/сутки.

   **Средний трафик:** 18.62 Гбайт/сутки * 8 / 86400 сек = 1851851 бит/с = 1.85 Мбит/с.

Для получения пиковых значений трафика и RPS умножим среднее потребление в два раза.

| Действие               | RPS  | Пиковый RPS | Средний трафик |  Пиковый трафик  | Суммарный суточный трафик  |
|------------------------|------|-------------|:--------------:|:----------------:|:--------------------------:|
| Просмотр календаря     | 1389 | 2778        | 389.28 Мбит/с  |  778.56 Мбит/с   |      3.82 Пбайт/сутки      |
| Создание события       | 232  | 464         |  2.11 Мбит/с   |   4.22 Мбит/с    |     21.23 Гбайт/сутки      |
| Редактирование события | 116  | 232         |  1.05 Мбит/с   |    2.1 Мбит/с    |     10.61 Гбайт/сутки      |
| Получение уведомления  | 463  | 926         |  1.85 Мбит/с   |    3.7 Мбит/с    |     18.62 Гбайт/сутки      |

## 3. Балансировка нагрузки

### Физическое расположение дата-центров

### Схема глобальной балансировки до дата-центров

## 4. Источники

1. https://www.patronum.io/key-google-workspace-statistics-for-2023/
2. https://hypestat.com/info/calendar.google.com
3. https://www.rfc-editor.org/errata_search.php?rfc=3696&eid=1690
4. https://www.ory.sh/docs/troubleshooting/bcrypt-secret-length
5. https://www.geekslop.com/technology-articles/2016/here-are-the-recommended-maximum-data-length-limits-for-common-database-and-programming-fields
6. https://developers.googleblog.com/2022/01/year-in-review-google-workspace.html
